<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ problem.title }} - C++ Grader</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">‚Üê Back to Problems</a>

    <div class="problem-header">
      <span class="difficulty {{ problem.difficulty }}">{{ problem.difficulty|upper }}</span>
      <h2>{{ problem.title }}</h2>
      <div class="problem-description">
        <p><strong>Description:</strong> {{ problem.description }}</p>
        {% if problem.input_format %}
        <p><strong>Input Format:</strong> {{ problem.input_format }}</p>
        {% endif %}
        {% if problem.output_format %}
        <p><strong>Output Format:</strong> {{ problem.output_format }}</p>
        {% endif %}
        {% if problem.constraints %}
        <p><strong>{{ problem.constraints }}</strong></p>
        {% endif %}
        {% if problem.sample_input %}
        <p><strong>Sample Input:</strong></p>
        <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin: 10px 0;">{{ problem.sample_input }}</pre>
        {% endif %}
        {% if problem.sample_output %}
        <p><strong>Sample Output:</strong></p>
        <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin: 10px 0;">{{ problem.sample_output }}</pre>
        {% endif %}
      </div>
    </div>

    <div class="editor-section">
      <h3 style="color: white; margin-top: 0;">Editor</h3>
      <div id="editor"></div>

      <div class="upload-section">
        <label for="fileUpload" class="upload-label">üìÅ Or Upload Code File (.cpp):</label>
        <input type="file" id="fileUpload" accept=".cpp,.c,.cc,.cxx" class="file-input">
        <button id="loadFileBtn" class="secondary-btn">Load File</button>
      </div>

      <div class="controls">
        <div class="control-group">
        <label>‚è±Ô∏è Time limit:</label>
        <span>{{ problem.time_limit }} s</span>
      </div>
      <div class="control-group">
        <label>üíæ Memory:</label>
        <span>{{ problem.memory_limit }} MB</span>
      </div>

        <button id="runBtn">‚ñ∂Ô∏è Run Code</button>
      </div>
    </div>

    <pre id="result"></pre>
  </div>

  <script>
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs' }});
    require(['vs/editor/editor.main'], function() {
      window.editor = monaco.editor.create(document.getElementById('editor'), {
        value: '#include <bits/stdc++.h>\nusing namespace std;\n\nint main() {\n    // Write your code here\n    return 0;\n}',
        language: 'cpp',
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 14,
        minimap: { enabled: false },
        scrollBeyondLastLine: false,
        roundedSelection: false,
        padding: { top: 10, bottom: 10 }
      });
    });

    document.getElementById("loadFileBtn").onclick = () => {
      const fileInput = document.getElementById("fileUpload");
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          window.editor.setValue(e.target.result);
        };
        reader.readAsText(file);
      } else {
        alert("Please select a file first");
      }
    };

    document.getElementById("runBtn").onclick = async () => {
      const code = window.editor.getValue();
      const resultBox = document.getElementById("result");

      resultBox.textContent = "‚è≥ Running your code...";

      const formData = new FormData();
      formData.append("code", code);
      formData.append("problem_id", "{{ problem_id }}");

      try {
        const res = await fetch("/submit", { method: "POST", body: formData });
        const data = await res.json();

        let msg = `${data.status}\n`;

        if (data.score !== undefined) {
          msg += `\nüéØ SCORE: ${data.score}/100\n`;
        }

        if (data.test_results) {
          msg += `\nüìä Test Results (time & memory per test):\n`;
          msg += `${'='.repeat(50)}\n`;
          data.test_results.forEach((result) => {
            const icon = result.passed ? '‚úì' : '‚úó';
            msg += `Test ${result.test_num}: ${result.status} ${icon} | ‚è±Ô∏è ${result.time_sec ?? '?'}s | üíæ ${result.memory_kb} KB\n`;
          });
          msg += `${'='.repeat(50)}\n`;
        }

        if (data.compile_log && data.compile_log.trim()) {
          msg += `\nüìã Compiler Log:\n${data.compile_log}\n`;
        }

        if (data.compile_time_sec !== undefined) {
          msg += `\n‚è±Ô∏è Compilation time: ${data.compile_time_sec} sec\n`;
        }

        resultBox.textContent = msg;
      } catch (error) {
        resultBox.textContent = "‚ùå Error running code: " + error.message;
      }
    };
  </script>
</body>
</html>